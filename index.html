<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SociAble ‚Äì Social Practice Sandbox</title>
    <style>
        /* Hackathon-ready: more than a chatbot */
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; min-height: 100vh; position: relative; display: flex; flex-direction: row; }
        /* Full-window background: same image as scenario (set via JS) */
        .scenario-bg { position: fixed; inset: 0; background-size: cover; background-position: center; background-repeat: no-repeat; z-index: -1; opacity: 0.6; }
        body::after { content: ''; position: fixed; inset: 0; background: linear-gradient(135deg, rgba(224,231,255,0.55) 0%, rgba(240,242,245,0.6) 100%); z-index: -1; pointer-events: none; }

        .tasks-bar { position: fixed; left: 0; top: 0; width: 260px; min-height: 100vh; background: rgba(255,255,255,0.98); border-right: 1px solid #e2e8f0; padding: 16px 12px; padding-top: 52px; z-index: 45; transform: translateX(-100%); transition: transform 0.3s ease; box-shadow: 4px 0 24px rgba(0,0,0,0.1); }
        .tasks-bar.open { transform: translateX(0); }
        .tasks-bar .tasks-bar-header { position: absolute; top: 12px; left: 12px; right: 12px; display: flex; align-items: center; justify-content: space-between; }
        .tasks-bar h2 { margin: 0; font-size: 1.1rem; color: #3730a3; padding: 0 4px; }
        .tasks-bar-close { width: 32px; height: 32px; padding: 0; background: #dc2626; color: white; border: none; border-radius: 50%; font-size: 18px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; transition: background 0.2s, transform 0.15s; }
        .tasks-bar-close:hover { background: #b91c1c; transform: scale(1.05); }
        .btn-tasks-toggle { position: fixed; left: 16px; top: 16px; min-width: 48px; height: 48px; padding: 0 14px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 0.9rem; font-weight: 600; z-index: 50; display: flex; align-items: center; justify-content: center; gap: 6px; box-shadow: 0 4px 14px rgba(79,70,229,0.4); transition: opacity 0.25s ease, transform 0.25s ease; }
        .btn-tasks-toggle:hover { filter: brightness(1.08); transform: translateY(-1px); box-shadow: 0 6px 18px rgba(79,70,229,0.45); }
        .btn-tasks-toggle.hidden { opacity: 0; pointer-events: none; transform: translateX(-8px); }
        .btn-tasks-toggle .btn-tasks-icon { font-size: 1.15rem; }
        .tasks-list { list-style: none; margin: 0; padding: 0; }
        .tasks-list li { padding: 10px 12px; margin-bottom: 6px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; gap: 8px; background: #f8fafc; border: 1px solid #e2e8f0; transition: background 0.2s; }
        .tasks-list li:hover { background: #e0e7ff; border-color: #a5b4fc; }
        .tasks-list .task-label { font-size: 0.85rem; color: #374151; flex: 1; min-width: 0; }
        .tasks-list .task-reward { font-size: 0.8rem; font-weight: 700; color: #92400e; flex-shrink: 0; }
        .tasks-list li.task-done .task-reward { color: #166534; }
        .tasks-list li.task-current { background: #e0e7ff; border-color: #818cf8; }
        .task-popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 500; }
        .task-popup-overlay.visible { display: flex; }
        .task-popup-overlay.visible .task-popup-box { animation: taskPopIn 0.35s cubic-bezier(0.34, 1.2, 0.64, 1) forwards; }
        @keyframes taskPopIn { from { opacity: 0; transform: scale(0.92); } to { opacity: 1; transform: scale(1); } }
        .task-popup-box { position: relative; background: white; border-radius: 16px; padding: 24px; padding-top: 44px; max-width: 400px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .task-popup-box .task-popup-close { position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; padding: 0; background: #dc2626; color: white; border: none; border-radius: 50%; font-size: 20px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .task-popup-box .task-popup-close:hover { background: #b91c1c; }
        .task-popup-box h3 { margin: 0 0 8px; color: #3730a3; font-size: 1.15rem; }
        .task-popup-box .task-popup-desc { margin: 0 0 12px; color: #374151; font-size: 0.9rem; line-height: 1.5; }
        .task-popup-box .task-popup-reward { font-weight: 700; color: #92400e; font-size: 0.95rem; }
        .task-popup-box .task-popup-done { color: #166534; font-weight: 600; }
        .btn-logout { position: fixed; top: 16px; right: 20px; padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; z-index: 51; display: none; }
        .btn-logout:hover { background: #b91c1c; }
        .btn-logout.visible { display: inline-block; }
        
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px; min-width: 0; }
        .hero { text-align: center; margin-bottom: 16px; }
        .hero h1 { margin: 0; font-size: 1.75rem; color: #3730a3; }
        .hero p { margin: 4px 0 0; font-size: 0.9rem; color: #6366f1; }
        .nav-link { background: transparent; border: 1px solid #818cf8; color: #4f46e5; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; margin-top: 8px; text-decoration: none; display: inline-block; }
        .nav-link:hover { background: #e0e7ff; }

        .container { width: 100%; max-width: 900px; height: 560px; background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; overflow: hidden; }
        
        .visual-panel { width: 40%; background: #e0e7ff; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 20px; text-align: center; }
        .visual-panel h3 { margin: 0 0 12px; font-size: 1rem; color: #3730a3; }
        .scenario-selector { margin-bottom: 8px; padding: 10px; border-radius: 8px; border: 1px solid #a5b4fc; width: 100%; max-width: 200px; background: #fff; }
        .scenario-goal { font-size: 0.8rem; color: #6366f1; margin-bottom: 12px; min-height: 2.2em; font-style: italic; }
        .scenario-goal .badge { display: inline-block; background: #22c55e; color: white; padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; font-style: normal; margin-top: 4px; }
        .avatar-box { width: 160px; height: 160px; background: #c7d2fe; border-radius: 50%; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; font-size: 64px; border: 5px solid white; transition: all 0.3s ease; overflow: hidden; }
        .avatar-box img.avatar-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .avatar-box .avatar-emoji { display: none; }
        .avatar-box.avatar-emoji-mode .avatar-emoji { display: block; }
        .avatar-box.avatar-emoji-mode .avatar-img { display: none !important; }
        .mood-text { color: #666; font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; }
        .session-stats { font-size: 0.75rem; color: #6b7280; margin-bottom: 8px; }
        .btn-end { padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        .btn-end:hover { background: #4f46e5; }
        
        .chat-panel { width: 60%; display: flex; flex-direction: column; }
        .chat-window { flex: 1; padding: 20px; overflow-y: auto; background: #fff; border-bottom: 1px solid #eee; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 18px; max-width: 70%; line-height: 1.4; font-size: 14px; opacity: 1; transform: translateY(0); }
        .message.user { background: #4f46e5; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 4px; }
        .message.ai { background: #f3f4f6; color: #333; align-self: flex-start; border-bottom-left-radius: 4px; }
        .message.message-enter { animation: messageSlideIn 0.35s cubic-bezier(0.34, 1.2, 0.64, 1) forwards; }
        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(8px) scale(0.97); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .suggestions-row { padding: 10px 16px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; min-height: 48px; }
        .suggestions-row .label { font-size: 0.8rem; color: #64748b; margin-right: 8px; flex-shrink: 0; }
        .suggestion-chip { padding: 8px 14px; background: #e0e7ff; color: #4338ca; border: 1px solid #a5b4fc; border-radius: 20px; cursor: pointer; font-size: 0.85rem; }
        .suggestion-chip:hover { background: #c7d2fe; }
        .input-area { padding: 16px; background: #fff; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        button.send-btn { padding: 10px 24px; background: #4f46e5; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; }
        button.send-btn:hover { background: #4338ca; }
        .btn-mic { width: 44px; height: 44px; border-radius: 50%; border: 2px solid #a5b4fc; background: #e0e7ff; color: #4f46e5; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .btn-mic:hover { background: #c7d2fe; }
        .btn-mic.listening { background: #ef4444; border-color: #dc2626; color: white; animation: micPulse 1s ease-in-out infinite; }
        @keyframes micPulse { 50% { transform: scale(1.05); } }
        .stt-hint { font-size: 0.75rem; color: #6b7280; margin-top: 6px; padding: 0 4px; }
        .stt-hint a { color: #6366f1; }
        .listening-toast { position: fixed; bottom: 180px; left: 50%; transform: translateX(-50%); background: #4f46e5; color: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none; z-index: 98; font-weight: 600; }
        .listening-toast.visible { display: block; animation: popIn 0.3s ease; }
        button.try-again { padding: 8px 14px; background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; border-radius: 20px; cursor: pointer; font-size: 0.85rem; }
        button.try-again:hover { background: #fde68a; }

        .feedback-toast {
            position: fixed; top: 20px; right: 20px; background: #fee2e2; color: #b91c1c; 
            padding: 14px 18px; border-radius: 8px; border-left: 5px solid #ef4444; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; animation: slideIn 0.3s ease; z-index: 100; max-width: 320px;
        }
        .feedback-toast .try-hint { margin-top: 8px; font-size: 0.85rem; color: #991b1b; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .goal-toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #dcfce7; color: #166534;
            padding: 12px 20px; border-radius: 12px; border: 2px solid #22c55e; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none; animation: popIn 0.3s ease; z-index: 99; font-weight: 600;
        }
        @keyframes popIn { from { opacity: 0; transform: translateX(-50%) scale(0.9); } to { opacity: 1; transform: translateX(-50%) scale(1); } }

        .recap-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 200; }
        .recap-overlay.visible { display: flex; }
        .recap-box { background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .recap-box h2 { margin: 0 0 16px; color: #3730a3; font-size: 1.25rem; }
        .recap-box p { margin: 0 0 12px; color: #374151; font-size: 0.95rem; line-height: 1.5; }
        .recap-box .stat { background: #e0e7ff; padding: 8px 12px; border-radius: 8px; margin: 8px 0; }
        .recap-box button { margin-top: 16px; padding: 10px 24px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .recap-box button:hover { background: #4338ca; }

        /* Login overlay ‚Äì covers screen until user logs in */
        .login-overlay {
            position: fixed; inset: 0; background: linear-gradient(135deg, #3730a3 0%, #6366f1 100%);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .login-overlay.hidden { display: none; }
        .login-box {
            background: white; border-radius: 16px; padding: 32px; width: 100%; max-width: 360px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .login-box h2 { margin: 0 0 24px; color: #3730a3; font-size: 1.5rem; text-align: center; }
        .login-box label { display: block; margin-bottom: 4px; font-size: 0.9rem; color: #374151; }
        .login-box input[type="text"],
        .login-box input[type="password"] {
            width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid #ddd; border-radius: 8px;
            font-size: 1rem; box-sizing: border-box;
        }
        .login-box button { width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; }
        .login-box .btn-login { background: #4f46e5; color: white; }
        .login-box .btn-login:hover { background: #4338ca; }
        .login-box .btn-signup { background: #e0e7ff; color: #4f46e5; }
        .login-box .btn-signup:hover { background: #c7d2fe; }
        .login-box .welcome { margin-top: 16px; font-size: 0.9rem; color: #22c55e; text-align: center; display: none; }

        .coins-bar { position: fixed; top: 16px; right: 110px; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; z-index: 50; }
        .coins-bar .coin-count { background: #fef3c7; color: #92400e; padding: 6px 12px; border-radius: 20px; font-weight: 700; }
        .coins-bar .btn-shop { padding: 6px 14px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        .coins-bar .btn-shop:hover { background: #4338ca; }

        .shop-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 300; }
        .shop-overlay.visible { display: flex; }
        .shop-overlay.visible .shop-box { animation: shopBob 0.5s ease-out; }
        @keyframes shopBob {
            0% { transform: scale(0.9) translateY(-20px); opacity: 0; }
            50% { transform: scale(1.02) translateY(4px); }
            70% { transform: scale(0.98) translateY(-2px); }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .shop-box { position: relative; background: white; border-radius: 16px; padding: 24px; padding-top: 36px; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .shop-box .shop-close-x { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; padding: 0; background: #dc2626; color: white; border: none; border-radius: 50%; font-size: 18px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .shop-box .shop-close-x:hover { background: #b91c1c; }
        .shop-box h2 { margin: 0 0 8px; color: #3730a3; font-size: 1.25rem; }
        .shop-box .shop-coins { font-size: 0.9rem; color: #6366f1; margin-bottom: 16px; }
        .shop-item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px 14px; margin-bottom: 10px; }
        .shop-item.owned { border-color: #22c55e; background: #dcfce7; }
        .shop-item h4 { margin: 0 0 4px; font-size: 1rem; color: #374151; }
        .shop-item p { margin: 0 0 8px; font-size: 0.85rem; color: #6b7280; }
        .shop-item .cost { font-weight: 700; color: #92400e; }
        .shop-item button { padding: 6px 12px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        .shop-item button:hover { background: #4338ca; }
        .shop-item button:disabled { background: #9ca3af; cursor: not-allowed; }
        .shop-item .owned-badge { color: #166534; font-size: 0.85rem; font-weight: 600; }

        /* Rewards */
        .avatar-box.reward-star-border { box-shadow: 0 0 0 4px #fbbf24, 0 0 20px rgba(251,191,36,0.5); }
        body.reward-rainbow .chat-panel .chat-window { background: linear-gradient(135deg, #fef3c7 0%, #fce7f3 25%, #e0e7ff 50%, #d1fae5 75%, #fef3c7 100%); background-size: 200% 200%; animation: rainbowBg 8s ease infinite; }
        @keyframes rainbowBg { 0%,100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        body.reward-rainbow .message.user { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        body.reward-rainbow .message.ai { background: rgba(255,255,255,0.9); }
        .coins-bar .reward-kindness-badge { font-size: 1.1rem; margin-left: 4px; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 150; }
        .certificate-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 400; }
        .certificate-overlay.visible { display: flex; }
        .certificate-box { background: #fff; padding: 32px; border-radius: 12px; max-width: 480px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .certificate-box h2 { color: #3730a3; margin: 0 0 8px; font-size: 1.5rem; }
        .certificate-box .cert-subtitle { color: #6366f1; margin-bottom: 16px; font-size: 0.95rem; }
        .certificate-box .cert-name { font-size: 1.25rem; font-weight: 700; color: #374151; margin: 16px 0; }
        .certificate-box .cert-date { font-size: 0.9rem; color: #6b7280; margin-bottom: 20px; }
        .certificate-box button { padding: 10px 24px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 0 8px 8px 0; }
        .certificate-box button:hover { background: #4338ca; }
        .voice-toggle { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #6b7280; margin-left: 8px; }
        .voice-toggle input { width: auto; flex: none; }
        @media print {
            body * { visibility: hidden; }
            .certificate-overlay, .certificate-overlay * { visibility: visible; }
            .certificate-overlay { position: absolute; inset: 0; background: white; }
            .certificate-box { max-width: none; box-shadow: none; }
        }
    </style>
</head>
<body>
<!-- Full-window background: same image as scenarioImg (updated in JS); scenarioImageContainer unchanged -->
<div class="scenario-bg" id="scenarioBg"></div>

<!-- Login overlay: shown on load, hidden after successful login -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <h2>SociAble</h2>
        <label for="loginUsername">Username</label>
        <input type="text" id="loginUsername" placeholder="Username" autocomplete="username">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
        <button type="button" class="btn-login" id="btnLogin">Login</button>
        <button type="button" class="btn-signup" id="btnSignup">Sign Up</button>
        <p class="welcome" id="loginWelcome">Welcome! Loading...</p>
    </div>
</div>

<button type="button" class="btn-tasks-toggle" id="btnTasksToggle" title="Open tasks"><span class="btn-tasks-icon" aria-hidden="true">‚ò∞</span><span>Tasks</span></button>

<button type="button" class="btn-logout" id="btnLogout">Log out</button>

<div class="coins-bar" id="coinsBar" style="display: none;">
    <span class="reward-kindness-badge" id="kindnessBadge" style="display: none;" title="Kindness Badge">üèÖ</span>
    <span class="coin-count">ü™ô <span id="coinCount">0</span> coins</span>
    <button type="button" class="btn-shop" id="btnShop">Reward Shop</button>
</div>

<aside class="tasks-bar" id="tasksBar">
    <div class="tasks-bar-header">
        <h2>Tasks</h2>
        <button type="button" class="tasks-bar-close" id="tasksBarClose" aria-label="Close">√ó</button>
    </div>
    <ul class="tasks-list" id="tasksList"></ul>
</aside>

<div class="main-content">
<div class="hero">
    <h1>SociAble</h1>
    <p>Practice social situations in a safe sandbox. Your words change how the character feels.</p>
    <a href="about.html" class="nav-link">What is SociAble?</a>
    <a href="dashboard.html" class="nav-link" style="margin-left: 8px;">Analytics</a>
</div>


<div class="container">
    <div class="visual-panel">
        <h3>Current Scenario</h3>
        <select id="scenarioSelect" class="scenario-selector">
            <option value="Grocery Store">Grocery Store</option>
            <option value="Playground">Playground</option>
            <option value="Classroom">Classroom</option>
        </select>
        <p class="scenario-goal" id="scenarioGoal">Task: Pick a scenario and say hello.</p>
        
        <div class="avatar-box avatar-emoji-mode" id="avatarDisplay">
            <img id="avatarImg" class="avatar-img" src="" alt="Character" style="display: none;">
            <span class="avatar-emoji" id="avatarEmoji">üòê</span>
        </div>
        <p id="moodText" class="mood-text">Neutral</p>
        <p class="session-stats" id="sessionStats">Kind moments: 0 ¬∑ Flagged: 0</p>
        <button type="button" class="btn-end" id="btnEndPractice">End practice</button>
    </div>

    <div class="chat-panel">
        <div class="chat-window" id="chatWindow">
            <div class="message ai">Hi! I'm ready to practice. Pick a scenario and say hello!</div>
        </div>
        <div class="suggestions-row" id="suggestionsRow">
            <span class="label">Suggest:</span>
            <button type="button" class="suggestion-chip" data-text="Hi!">Hi!</button>
            <button type="button" class="suggestion-chip" data-text="Hello!">Hello!</button>
            <button type="button" class="suggestion-chip" data-text="Can you help me?">Can you help me?</button>
            <button type="button" class="suggestion-chip" data-text="Thank you">Thank you</button>
        </div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Type or tap mic to speak..." onkeypress="handleEnter(event)">
            <button type="button" class="btn-mic" id="btnMic" title="Speak">üé§</button>
            <button type="button" class="try-again" id="btnTryAgain" style="display: none;">Try again</button>
            <button type="button" class="send-btn" onclick="sendMessage()">Send</button>
            <div class="voice-toggle">
                <label><input type="checkbox" id="voiceRepliesCheck" checked> Hear replies</label>
            </div>
        </div>
        <p class="stt-hint" id="sttHint">Tap the mic, then speak. Your words appear in the box ‚Äî tap Send or mic again to stop. Works best in <strong>Chrome or Edge</strong> on <strong>https://</strong> or <strong>localhost</strong>. Allow microphone when asked.</p>
    </div>
</div>
</div><!-- .main-content -->

<div class="task-popup-overlay" id="taskPopupOverlay">
    <div class="task-popup-box" onclick="event.stopPropagation()">
        <button type="button" class="task-popup-close" id="taskPopupClose" aria-label="Close">√ó</button>
        <h3 id="taskPopupTitle">Task</h3>
        <p class="task-popup-desc" id="taskPopupDesc"></p>
        <p class="task-popup-reward" id="taskPopupReward"></p>
        <p class="task-popup-done" id="taskPopupDone" style="display: none;">‚úì Completed</p>
    </div>
</div>

<div class="listening-toast" id="listeningToast">Listening ‚Äî speak now! Tap mic again to stop.</div>

<div id="feedbackToast" class="feedback-toast">
    <strong>‚ö†Ô∏è Vibe Check:</strong> <span id="feedbackText"></span>
    <div class="try-hint" id="tryHint">Try rephrasing in a kinder way, then click "Try again" to focus.</div>
</div>
<div id="goalToast" class="goal-toast">üéâ Goal reached! You made them smile.</div>

<div class="recap-overlay" id="recapOverlay">
    <div class="recap-box">
        <h2>Practice summary</h2>
        <p id="recapSummary">No messages yet. Send a few and come back!</p>
        <div class="stat" id="recapStats"></div>
        <p id="recapTip" style="font-size: 0.85rem; color: #6b7280;"></p>
        <button type="button" id="btnCloseRecap">Start new practice</button>
    </div>
</div>

<canvas id="confetti-canvas" aria-hidden="true"></canvas>
<div class="certificate-overlay" id="certificateOverlay">
    <div class="certificate-box" id="certificateBox">
        <h2>Certificate of Kindness</h2>
        <p class="cert-subtitle">SociAble</p>
        <p class="cert-name" id="certUserName">‚Äî</p>
        <p>has practiced being kind and friendly in social situations.</p>
        <p class="cert-date" id="certDate">‚Äî</p>
        <button type="button" id="certPrint">Print</button>
        <button type="button" id="certClose">Close</button>
    </div>
</div>
<div class="shop-overlay" id="shopOverlay">
    <div class="shop-box">
        <button type="button" class="shop-close-x" id="shopCloseX" aria-label="Close shop">√ó</button>
        <h2>Reward Shop</h2>
        <p class="shop-coins">You have <strong id="shopCoinCount">0</strong> coins</p>
        <div id="shopRewardsList"></div>
    </div>
</div>

<script>
    const API_BASE = 'http://127.0.0.1:8000/api';
    let userToken = null; // Auth token; set after login

    const chatWindow = document.getElementById('chatWindow');
    const avatarDisplay = document.getElementById('avatarDisplay');
    const moodText = document.getElementById('moodText');
    const feedbackToast = document.getElementById('feedbackToast');
    const userInput = document.getElementById('userInput');
    const btnTryAgain = document.getElementById('btnTryAgain');
    const scenarioSelect = document.getElementById('scenarioSelect');
    const scenarioGoalEl = document.getElementById('scenarioGoal');
    const sessionStatsEl = document.getElementById('sessionStats');
    const recapOverlay = document.getElementById('recapOverlay');
    const recapSummary = document.getElementById('recapSummary');
    const recapStats = document.getElementById('recapStats');
    const recapTip = document.getElementById('recapTip');
    const goalToast = document.getElementById('goalToast');
    const loginOverlay = document.getElementById('loginOverlay');
    const loginWelcome = document.getElementById('loginWelcome');
    const suggestionsRow = document.getElementById('suggestionsRow');
    const coinsBar = document.getElementById('coinsBar');
    const coinCountEl = document.getElementById('coinCount');
    const shopOverlay = document.getElementById('shopOverlay');
    const shopCoinCount = document.getElementById('shopCoinCount');
    const shopRewardsList = document.getElementById('shopRewardsList');

    // Suggestion chips: click sends that text as the message (dialogue-based)
    suggestionsRow.addEventListener('click', function (e) {
        const chip = e.target.closest('.suggestion-chip');
        if (!chip) return;
        const text = chip.getAttribute('data-text');
        if (text) {
            userInput.value = text;
            sendMessage();
        }
    });

    function renderSuggestions(suggestions) {
        suggestionsRow.innerHTML = '';
        const label = document.createElement('span');
        label.className = 'label';
        label.textContent = 'Suggest:';
        suggestionsRow.appendChild(label);
        (suggestions || []).forEach(function (s) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'suggestion-chip';
            btn.setAttribute('data-text', s);
            btn.textContent = s;
            suggestionsRow.appendChild(btn);
        });
    }

    // Restore token from localStorage (e.g. after refresh or when opening dashboard)
    if (localStorage.getItem('sociable_token')) {
        userToken = localStorage.getItem('sociable_token');
        loginOverlay.classList.add('hidden');
        fetchProfile();
    }

    // Session stats (makes it a practice tool, not just chat)
    let kindMoments = 0, flaggedCount = 0, hurtMoments = 0, totalMessages = 0;
    const scenariosUsed = new Set();
    let goalTierIndex = 0; // progress-based goals
    let purchasedRewardIds = [];
    let storedUsername = '';

    // Progress-based tiers: after N kind messages, milestone completes and coins increase
    const GOAL_TIERS = [
        { kindRequired: 3, coins: 10 },
        { kindRequired: 6, coins: 25 },
        { kindRequired: 10, coins: 50 },
        { kindRequired: 15, coins: 100 }
    ];

    // Scenario-based goal options: one is picked at random when the child selects that scenario (dynamic each time)
    const SCENARIO_GOAL_OPTIONS = {
        'Grocery Store': [
            'Ask the character to help you find an item in the store (e.g. milk, bread, cereal).',
            'Ask where something is in the store, using "please" and "thank you".',
            'Ask for help reaching something on a high shelf.',
            'Ask the character to help you find the right aisle for an item.',
            'Ask politely if they can help you with your shopping.'
        ],
        'Playground': [
            'Ask how to use a toy or equipment (e.g. swing, slide, how to play a game).',
            'Ask if you can join a game or play with others.',
            'Ask someone to explain the rules of a game.',
            'Ask for help when you can\'t figure out how something works.',
            'Ask politely to take turns on the swings or slide.'
        ],
        'Classroom': [
            'Ask the teacher or a friend for help with something you don\'t understand.',
            'Ask how to use something in the classroom (e.g. pencil sharpener, where something is).',
            'Ask to borrow something politely (e.g. an eraser, a crayon).',
            'Ask where to put your things or find your seat.',
            'Ask for help finding a book or a supply.'
        ]
    };

    var currentScenarioGoalText = '';
    var currentScenarioForGoal = '';

    function pickNewScenarioGoal(scenario) {
        var options = SCENARIO_GOAL_OPTIONS[scenario];
        if (!options || options.length === 0) {
            currentScenarioGoalText = 'Be kind and friendly.';
            currentScenarioForGoal = scenario;
            return;
        }
        currentScenarioForGoal = scenario;
        currentScenarioGoalText = options[Math.floor(Math.random() * options.length)];
    }

    const SCENARIO_IMAGES = {
    'Grocery Store': 'static/grocery_shop.png',
    'Playground': 'static/playground.png',
    'Classroom': 'static/classroom.png'
    };

    // Scenario ‚Üí character folder name (images: static/{character}/{character}-{mood}.png). No entry = emoji fallback.
    const SCENARIO_CHARACTER = {
        'Grocery Store':'cashier',
        'Playground': 'kid',
        'Classroom': 'student'
    };

    document.getElementById('btnEndPractice').onclick = function () { showRecap(); };
    document.getElementById('btnCloseRecap').onclick = function () {
        recapOverlay.classList.remove('visible');
        resetChat();
    };
    document.getElementById('btnShop').onclick = openShop;
    document.getElementById('shopCloseX').onclick = function () { shopOverlay.classList.remove('visible'); };
    scenarioSelect.addEventListener('change', function () {
        pickNewScenarioGoal(scenarioSelect.value);
        resetChat();
        updateScenarioGoal();
    });
    const taskPopupOverlay = document.getElementById('taskPopupOverlay');
    const taskPopupClose = document.getElementById('taskPopupClose');
    document.getElementById('taskPopupClose').onclick = function () { taskPopupOverlay.classList.remove('visible'); };
    taskPopupOverlay.addEventListener('click', function (e) { if (e.target === taskPopupOverlay) taskPopupOverlay.classList.remove('visible'); });
    var tasksBar = document.getElementById('tasksBar');
    var btnTasksToggle = document.getElementById('btnTasksToggle');
    function openTasksPanel() {
        tasksBar.classList.add('open');
        btnTasksToggle.classList.add('hidden');
        btnTasksToggle.setAttribute('title', 'Close tasks');
    }
    function closeTasksPanel() {
        tasksBar.classList.remove('open');
        btnTasksToggle.classList.remove('hidden');
        btnTasksToggle.setAttribute('title', 'Open tasks');
    }
    btnTasksToggle.onclick = openTasksPanel;
    document.getElementById('tasksBarClose').onclick = closeTasksPanel;
    document.getElementById('btnLogout').onclick = function () {
        userToken = null;
        localStorage.removeItem('sociable_token');
        loginOverlay.classList.remove('hidden');
        coinsBar.style.display = 'none';
        document.getElementById('btnLogout').classList.remove('visible');
    };
    btnTryAgain.onclick = function () { userInput.focus(); };
    document.getElementById('btnLogin').onclick = handleLogin;
    document.getElementById('btnSignup').onclick = handleSignup;

    async function fetchProfile() {
        if (!userToken) return;
        try {
            const r = await fetch(API_BASE + '/profile/', { headers: { 'Authorization': 'Token ' + userToken } });
            if (r.ok) {
                const d = await r.json();
                coinCountEl.textContent = d.coins;
                shopCoinCount.textContent = d.coins;
                coinsBar.style.display = 'flex';
                document.getElementById('btnLogout').classList.add('visible');
                purchasedRewardIds = d.purchased_reward_ids || [];
                storedUsername = d.username || '';
                applyRewards();
            }
        } catch (e) { console.warn('Profile fetch failed', e); }
    }

    function applyRewards() {
        document.body.classList.toggle('reward-rainbow', purchasedRewardIds.indexOf('rainbow_theme') !== -1);
        avatarDisplay.classList.toggle('reward-star-border', purchasedRewardIds.indexOf('star_border') !== -1);
        document.getElementById('kindnessBadge').style.display = purchasedRewardIds.indexOf('kindness_badge') !== -1 ? 'inline' : 'none';
        if (purchasedRewardIds.indexOf('certificate') !== -1) {
            if (!document.getElementById('btnCertificate')) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-shop';
                btn.id = 'btnCertificate';
                btn.textContent = 'Certificate';
                btn.onclick = openCertificate;
                coinsBar.appendChild(btn);
            }
        } else {
            const b = document.getElementById('btnCertificate');
            if (b) b.remove();
        }
    }

    async function awardCoins(amount) {
        if (!userToken || !amount) return;
        try {
            const r = await fetch(API_BASE + '/coins/award/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Token ' + userToken },
                body: JSON.stringify({ amount: amount })
            });
            if (r.ok) {
                const d = await r.json();
                coinCountEl.textContent = d.coins;
                shopCoinCount.textContent = d.coins;
            }
        } catch (e) { console.warn('Award coins failed', e); }
    }

    async function openShop() {
        shopOverlay.classList.add('visible');
        if (!userToken) return;
        try {
            const r = await fetch(API_BASE + '/shop/', { headers: { 'Authorization': 'Token ' + userToken } });
            if (!r.ok) return;
            const d = await r.json();
            shopCoinCount.textContent = d.coins;
            shopRewardsList.innerHTML = '';
            (d.rewards || []).forEach(function (reward) {
                const div = document.createElement('div');
                div.className = 'shop-item' + (reward.owned ? ' owned' : '');
                div.innerHTML = '<h4>' + reward.name + '</h4><p>' + reward.description + '</p>' +
                    (reward.owned ? '<span class="owned-badge">‚úì Owned</span>' :
                        '<span class="cost">' + reward.cost + ' coins</span> &nbsp; <button type="button" data-reward-id="' + reward.id + '" data-cost="' + reward.cost + '">Redeem</button>');
                shopRewardsList.appendChild(div);
            });
            shopRewardsList.querySelectorAll('button[data-reward-id]').forEach(function (btn) {
                btn.onclick = function () { redeemReward(btn.getAttribute('data-reward-id'), parseInt(btn.getAttribute('data-cost'), 10)); };
            });
        } catch (e) { console.warn('Shop fetch failed', e); }
    }

    async function redeemReward(rewardId, cost) {
        if (!userToken || !rewardId) return;
        try {
            const r = await fetch(API_BASE + '/shop/redeem/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Token ' + userToken },
                body: JSON.stringify({ reward_id: rewardId })
            });
            const d = await r.json().catch(function () { return {}; });
            if (r.ok) {
                coinCountEl.textContent = d.coins;
                shopCoinCount.textContent = d.coins;
                purchasedRewardIds = d.purchased_reward_ids || [];
                applyRewards();
                openShop(); // refresh list to show owned
            } else {
                alert(d.error || 'Could not redeem.');
            }
        } catch (e) { alert('Error: ' + e.message); }
    }

    async function handleSignup() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!username || !password) {
            alert('Please enter a username and password.');
            return;
        }
        try {
            const response = await fetch(API_BASE + '/signup/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: password })
            });
            const data = response.ok ? await response.json().catch(() => ({})) : null;
            if (response.ok) {
                alert('Sign up successful! You can now log in.');
            } else {
                const err = data && (data.username || data.password || data.non_field_errors);
                alert('Sign up failed: ' + (err ? (Array.isArray(err) ? err.join(' ') : err) : response.statusText));
            }
        } catch (e) {
            alert('Sign up failed: ' + e.message);
        }
    }

    async function handleLogin() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!username || !password) {
            alert('Please enter username and password.');
            return;
        }
        loginWelcome.style.display = 'block';
        loginWelcome.textContent = 'Logging in...';
        try {
            const response = await fetch(API_BASE + '/login/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: password })
            });
            const data = await response.json().catch(() => ({}));
            if (response.ok && data.token) {
                userToken = data.token;
                localStorage.setItem('sociable_token', userToken);
                loginWelcome.textContent = 'Welcome, ' + username + '!';
                fetchProfile();
                document.getElementById('btnLogout').classList.add('visible');
                setTimeout(function () {
                    loginOverlay.classList.add('hidden');
                }, 800);
            } else {
                loginWelcome.style.display = 'none';
                alert('Login failed: ' + (data.non_field_errors ? data.non_field_errors.join(' ') : 'Invalid credentials.'));
            }
        } catch (e) {
            loginWelcome.style.display = 'none';
            alert('Login failed: ' + e.message);
        }
    }

    const DEFAULT_GREETING = "Hi! I'm ready to practice. Pick a scenario and say hello!";

    function resetChat() {
        chatWindow.innerHTML = '';
        const div = document.createElement('div');
        div.className = 'message ai';
        div.textContent = DEFAULT_GREETING;
        chatWindow.appendChild(div);
        kindMoments = 0;
        flaggedCount = 0;
        hurtMoments = 0;
        totalMessages = 0;
        goalTierIndex = 0;
        scenariosUsed.clear();
        updateSessionStats();
        updateScenarioGoal();
        updateAvatar('NEUTRAL');
        renderSuggestions(['Hi!', 'Hello!', 'Can you help me?', 'Thank you']);
    }

    function renderTasksList() {
        const scenario = scenarioSelect.value;
        const options = SCENARIO_GOAL_OPTIONS[scenario];
        const ul = document.getElementById('tasksList');
        ul.innerHTML = '';
        if (!options || options.length === 0) {
            const li = document.createElement('li');
            li.innerHTML = '<span class="task-label">Be kind and friendly.</span><span class="task-reward">+5 coins</span>';
            ul.appendChild(li);
            return;
        }
        options.forEach(function (taskText) {
            const li = document.createElement('li');
            const isCurrent = (taskText === currentScenarioGoalText);
            if (isCurrent) li.classList.add('task-current');
            var shortLabel = taskText.length > 48 ? taskText.substring(0, 48) + '‚Ä¶' : taskText;
            li.innerHTML = '<span class="task-label">' + shortLabel + '</span><span class="task-reward">+5 coins</span>';
            li.setAttribute('data-task', taskText);
            li.onclick = function () {
                document.getElementById('taskPopupTitle').textContent = 'Task';
                document.getElementById('taskPopupDesc').textContent = taskText;
                document.getElementById('taskPopupReward').textContent = '+5 coins when you\'re kind ¬∑ +15 bonus when you complete this task.';
                document.getElementById('taskPopupDone').style.display = (isCurrent && goalTierIndex > 0) ? 'block' : 'none';
                document.getElementById('taskPopupOverlay').classList.add('visible');
            };
            ul.appendChild(li);
        });
    }

    function updateScenarioGoal() {
        const scenario = scenarioSelect.value;
        if (scenario !== currentScenarioForGoal || !currentScenarioGoalText) {
            pickNewScenarioGoal(scenario);
        }
        var goalText = currentScenarioGoalText || 'Be kind and friendly.';
        if (goalTierIndex >= GOAL_TIERS.length) {
            scenarioGoalEl.innerHTML = 'All milestones done! ' + goalText + ' <span class="badge">‚òÖ</span>';
        } else {
            const tier = GOAL_TIERS[goalTierIndex];
            const soFar = Math.min(kindMoments, tier.kindRequired);
            scenarioGoalEl.innerHTML = '<strong>Task:</strong> ' + goalText + ' <span class="badge">' + soFar + '/' + tier.kindRequired + ' kind</span>';
        }
        renderTasksList();
        const scenarioImgUrl = SCENARIO_IMAGES[scenario];
        const scenarioBg = document.getElementById('scenarioBg');
        if (scenarioBg && scenarioImgUrl) {
            scenarioBg.style.backgroundImage = 'url(' + scenarioImgUrl + ')';
        }
    }
    function updateSessionStats() {
        sessionStatsEl.textContent = `Kind moments: ${kindMoments} ¬∑ Flagged: ${flaggedCount}${hurtMoments ? ` ¬∑ Hurt: ${hurtMoments}` : ''}`;
    }
    function showRecap() {
        const total = totalMessages;
        let summary;
        if (total === 0) {
            summary = 'No messages yet. Send a few and come back!';
        } else {
            summary = 'Overall: ' + total + ' message' + (total !== 1 ? 's' : '') + ' in this practice. ';
            summary += kindMoments + ' kind moment' + (kindMoments !== 1 ? 's' : '') + '. ';
            if (flaggedCount) summary += flaggedCount + ' rephrased (vibe check). ';
            if (hurtMoments) summary += 'The character felt hurt ' + hurtMoments + ' time(s). ';
            if (kindMoments > 0 && hurtMoments === 0) summary += 'Great job!';
            else if (kindMoments > 0) summary += 'Keep it up!';
            else summary += 'Try saying something kind next time.';
        }
        recapSummary.textContent = summary;
        recapStats.textContent = 'Scenario: ' + scenarioSelect.value + ' ¬∑ Kind: ' + kindMoments + ' ¬∑ Flagged: ' + flaggedCount + (hurtMoments ? ' ¬∑ Hurt: ' + hurtMoments : '');
        recapTip.textContent = kindMoments > 0 ? 'This conversation has been saved. Parents can review it in Analytics.' : 'Try saying something kind to see them smile.';
        recapOverlay.classList.add('visible');

        // Log conversation for parent review
        const messages = [];
        chatWindow.querySelectorAll('.message').forEach(function (el) {
            const sender = el.classList.contains('user') ? 'user' : 'assistant';
            const text = el.textContent.trim();
            const mood = el.getAttribute('data-mood') || '';
            messages.push({ sender: sender, text: text, mood: mood });
        });
        if (userToken && messages.length > 0) {
            fetch(API_BASE + '/practice/end/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Token ' + userToken },
                body: JSON.stringify({
                    scenario: scenarioSelect.value,
                    messages: messages,
                    total_messages: totalMessages,
                    kind_moments: kindMoments,
                    flagged_count: flaggedCount,
                    hurt_moments: hurtMoments
                })
            }).catch(function () {});
        }
    }
    function showGoalReached(tier) {
        goalToast.textContent = tier ? ('üéâ Goal ' + (goalTierIndex + 1) + ' complete! +' + tier.coins + ' coins') : 'üéâ Goal reached! You made them smile.';
        goalToast.style.display = 'block';
        if (purchasedRewardIds.indexOf('confetti') !== -1) runConfetti();
        setTimeout(function () { goalToast.style.display = 'none'; }, 2500);
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        const scenario = scenarioSelect.value;

        if (!text) return;

        addMessage(text, 'user');
        userInput.value = '';
        btnTryAgain.style.display = 'none';
        totalMessages++;
        scenariosUsed.add(scenario);

        // Build conversation history (all messages except the one we just added) for context
        const history = [];
        const messages = chatWindow.querySelectorAll('.message');
        for (let i = 0; i < messages.length - 1; i++) {
            const el = messages[i];
            const sender = el.classList.contains('user') ? 'user' : 'assistant';
            history.push({ sender: sender, text: el.textContent.trim() });
        }

        try {
            const headers = { 'Content-Type': 'application/json' };
            if (userToken) headers['Authorization'] = 'Token ' + userToken;
            const response = await fetch(API_BASE + '/chat/', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ message: text, scenario: scenario, history: history })
            });

            if (response.status === 401) {
                userToken = null;
                localStorage.removeItem('sociable_token');
                loginOverlay.classList.remove('hidden');
                addMessage('Please log in again.', 'ai', 'NEUTRAL');
                return;
            }
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server error: ${response.status} - ${errorText.substring(0, 100)}`);
            }
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const t = await response.text();
                throw new Error(`Expected JSON but got ${contentType}. Response: ${t.substring(0, 100)}`);
            }

            const data = await response.json();

            if (data.status === 'error') {
                addMessage(data.reply, 'ai', data.mood || 'NEUTRAL');
                updateAvatar(data.mood || 'NEUTRAL');
                renderSuggestions(data.suggestions || []);
            } else if (data.status === 'flagged') {
                flaggedCount++;
                updateSessionStats();
                showFeedback(data.feedback);
                chatWindow.lastElementChild.remove();
                btnTryAgain.style.display = 'inline-block';
                userInput.placeholder = 'Try a kinder way to say it...';
                setTimeout(() => { userInput.placeholder = 'Type your message here...'; }, 3000);
                renderSuggestions(data.suggestions || ['Hi!', 'Thank you', 'Can you help me?', 'Sorry']);
            } else {
                addMessage(data.reply, 'ai', data.mood);
                updateAvatar(data.mood);
                renderSuggestions(data.suggestions || []);
                if (data.mood === 'HAPPY') {
                    kindMoments++;
                    awardCoins(5); // 5 coins per kind moment
                    if (goalTierIndex < GOAL_TIERS.length && kindMoments >= GOAL_TIERS[goalTierIndex].kindRequired) {
                        const tier = GOAL_TIERS[goalTierIndex];
                        awardCoins(tier.coins);
                        showGoalReached(tier);
                        goalTierIndex++;
                    }
                    updateScenarioGoal();
                } else if (data.mood === 'SAD' || data.mood === 'ANGRY') {
                    hurtMoments++;
                }
                updateSessionStats();
            }
        } catch (error) {
            console.error('Error:', error);
            addMessage('‚ö†Ô∏è System Offline. Check backend terminal.', 'ai', 'NEUTRAL');
        }
    }

    let currentSpeechUtterance = null;

    function addMessage(text, sender, mood) {
        const div = document.createElement('div');
        div.className = 'message ' + sender + ' message-enter';
        div.textContent = text;
        if (sender === 'ai' && mood) div.setAttribute('data-mood', mood);
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        setTimeout(function () { div.classList.remove('message-enter'); }, 400);
        if (sender === 'ai' && document.getElementById('voiceRepliesCheck') && document.getElementById('voiceRepliesCheck').checked) {
            speakText(text);
        }
    }

    function getPreferredVoice() {
        const voices = window.speechSynthesis.getVoices();
        const en = voices.filter(function (v) { return v.lang.startsWith('en'); });
        var preferred = en.filter(function (v) {
            var n = v.name.toLowerCase();
            return n.indexOf('google') !== -1 || n.indexOf('samantha') !== -1 || n.indexOf('karen') !== -1 ||
                n.indexOf('daniel') !== -1 || n.indexOf('fiona') !== -1 || n.indexOf('moira') !== -1 ||
                n.indexOf('zira') !== -1 || n.indexOf('natural') !== -1 || n.indexOf('premium') !== -1;
        })[0];
        return preferred || en[0] || voices[0];
    }

    function speakWithBrowserTTS(text) {
        if (!window.speechSynthesis) return;
        if (currentSpeechUtterance) window.speechSynthesis.cancel();
        var chosen = getPreferredVoice();
        currentSpeechUtterance = new SpeechSynthesisUtterance(text.substring(0, 300));
        currentSpeechUtterance.rate = 0.88;
        currentSpeechUtterance.pitch = 1.02;
        if (chosen) currentSpeechUtterance.voice = chosen;
        currentSpeechUtterance.volume = 1;
        window.speechSynthesis.speak(currentSpeechUtterance);
    }

    function speakText(text) {
        var t = (text || '').substring(0, 500).trim();
        if (!t) return;
        fetch(API_BASE + '/tts/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: t })
        })
            .then(function (r) {
                if (!r.ok) throw new Error(r.status);
                return r.blob();
            })
            .then(function (blob) {
                var url = URL.createObjectURL(blob);
                var audio = new Audio(url);
                audio.onended = audio.onerror = function () { URL.revokeObjectURL(url); };
                audio.play();
            })
            .catch(function () {
                speakWithBrowserTTS(t);
            });
    }

    function updateAvatar(mood) {
        var scenario = scenarioSelect.value;
        var character = SCENARIO_CHARACTER[scenario];
        var moodKey = (mood || 'NEUTRAL').toLowerCase();
        if (moodKey === 'angry') moodKey = 'sad';
        var emoji = '\u{1F610}', color = '#c7d2fe';
        if (mood === 'HAPPY') { emoji = '\u{1F604}'; color = '#bbf7d0'; }
        if (mood === 'SAD') { emoji = '\u{1F622}'; color = '#fecaca'; }
        if (mood === 'ANGRY') { emoji = '\u{1F621}'; color = '#fecaca'; }
        if (character) {
            var src = 'static/' + character + '/' + character + '-' + moodKey + '.png';
            var img = document.getElementById('avatarImg');
            img.src = src;
            img.style.display = 'block';
            img.onerror = function () {
                img.style.display = 'none';
                avatarDisplay.classList.add('avatar-emoji-mode');
                document.getElementById('avatarEmoji').textContent = emoji;
            };
            avatarDisplay.classList.remove('avatar-emoji-mode');
            document.getElementById('avatarEmoji').textContent = emoji;
        } else {
            document.getElementById('avatarImg').style.display = 'none';
            document.getElementById('avatarImg').src = '';
            avatarDisplay.classList.add('avatar-emoji-mode');
            document.getElementById('avatarEmoji').textContent = emoji;
        }
        avatarDisplay.style.backgroundColor = color;
        moodText.textContent = mood ? mood.charAt(0).toUpperCase() + mood.slice(1).toLowerCase() : 'Neutral';
    }

    function showFeedback(text) {
        document.getElementById('feedbackText').textContent = text;
        feedbackToast.style.display = 'block';
        setTimeout(() => { feedbackToast.style.display = 'none'; }, 5000);
    }

    function runConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ec4899', '#8b5cf6'];
        const pieces = [];
        for (let i = 0; i < 80; i++) {
            pieces.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                w: 6 + Math.random() * 6,
                h: 6 + Math.random() * 4,
                color: colors[Math.floor(Math.random() * colors.length)],
                vx: (Math.random() - 0.5) * 4,
                vy: -4 - Math.random() * 6,
                rot: Math.random() * 360
            });
        }
        let frame = 0;
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            pieces.forEach(function (p) {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2;
                p.rot += 4;
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rot * Math.PI / 180);
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                ctx.restore();
            });
            frame++;
            if (frame < 120) requestAnimationFrame(draw);
            else canvas.style.display = 'none';
        }
        canvas.style.display = 'block';
        draw();
    }

    function openCertificate() {
        document.getElementById('certUserName').textContent = storedUsername || 'Practitioner';
        document.getElementById('certDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('certificateOverlay').classList.add('visible');
    }
    document.getElementById('certClose').onclick = function () {
        document.getElementById('certificateOverlay').classList.remove('visible');
    };
    document.getElementById('certPrint').onclick = function () {
        window.print();
    };

    (function initSpeech() {
        const btnMic = document.getElementById('btnMic');
        const sttHint = document.getElementById('sttHint');
        const listeningToast = document.getElementById('listeningToast');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (!window.isSecureContext) {
            sttHint.innerHTML = 'Microphone only works on <strong>HTTPS</strong> or <strong>http://localhost</strong>. Open this page via <code>https://</code> or <code>http://127.0.0.1:8000</code> (or localhost) to use speech.';
            btnMic.title = 'Use HTTPS or localhost first';
            btnMic.disabled = true;
            return;
        }
        if (!SpeechRecognition) {
            sttHint.textContent = 'Speech-to-text is not supported in this browser. Use Chrome or Edge.';
            btnMic.title = 'Speech not supported';
            btnMic.disabled = true;
            return;
        }

        const recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        recognition.maxAlternatives = 1;
        var isListening = false;

        function stopListening() {
            if (!isListening) return;
            isListening = false;
            btnMic.classList.remove('listening');
            listeningToast.classList.remove('visible');
            userInput.placeholder = 'Type or tap mic to speak...';
            try { recognition.stop(); } catch (e) {}
        }

        btnMic.onclick = function () {
            if (isListening) {
                stopListening();
                return;
            }
            userInput.placeholder = 'Listening...';
            userInput.value = '';
            listeningToast.classList.add('visible');
            try {
                recognition.start();
                isListening = true;
                btnMic.classList.add('listening');
            } catch (err) {
                stopListening();
                if (err.message && (err.message.indexOf('already') !== -1 || err.message.indexOf('start') !== -1)) {
                    userInput.placeholder = 'Tap mic again to start.';
                } else if (err.message && err.message.indexOf('not allowed') !== -1) {
                    sttHint.textContent = 'Microphone was blocked. Click the lock or info icon in the address bar and allow microphone, then try again.';
                }
            }
        };

        recognition.onresult = function (e) {
            var transcript = '';
            for (var i = 0; i < e.results.length; i++) {
                if (e.results[i].length > 0) transcript += e.results[i][0].transcript;
            }
            if (transcript) userInput.value = transcript;
        };

        recognition.onend = function () {
            stopListening();
        };

        recognition.onerror = function (e) {
            stopListening();
            if (e.error === 'not-allowed') {
                sttHint.textContent = 'Microphone was blocked. Allow microphone in your browser (address bar) and tap the mic again.';
            } else if (e.error === 'no-speech') {
                userInput.placeholder = 'No speech heard. Tap mic and try again.';
            } else if (e.error === 'network') {
                userInput.placeholder = 'Network error. Check connection and try again.';
            }
        };
    })();

    if (window.speechSynthesis) speechSynthesis.addEventListener('voiceschanged', function () { getPreferredVoice(); });

    if (localStorage.getItem('sociable_voice') !== null) {
        const v = document.getElementById('voiceRepliesCheck');
        if (v) v.checked = localStorage.getItem('sociable_voice') === '1';
    }
    document.getElementById('voiceRepliesCheck').addEventListener('change', function () {
        localStorage.setItem('sociable_voice', this.checked ? '1' : '0');
    });

    updateScenarioGoal();
    updateAvatar('NEUTRAL');
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SociAble ‚Äì Social Practice Sandbox</title>
    <style>
        /* Hackathon-ready: more than a chatbot */
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; position: relative; }
        /* Full-window background: same image as scenario (set via JS) */
        .scenario-bg { position: fixed; inset: 0; background-size: cover; background-position: center; background-repeat: no-repeat; z-index: -1; opacity: 0.6; }
        body::after { content: ''; position: fixed; inset: 0; background: linear-gradient(135deg, rgba(224,231,255,0.55) 0%, rgba(240,242,245,0.6) 100%); z-index: -1; pointer-events: none; }
        
        .hero { text-align: center; margin-bottom: 16px; }
        .hero h1 { margin: 0; font-size: 1.75rem; color: #3730a3; }
        .hero p { margin: 4px 0 0; font-size: 0.9rem; color: #6366f1; }
        .about-toggle { background: transparent; border: 1px solid #818cf8; color: #4f46e5; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; margin-top: 8px; }
        .about-toggle:hover { background: #e0e7ff; }
        .about-box { max-width: 560px; margin: 0 auto 16px; padding: 16px; background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); font-size: 0.9rem; line-height: 1.5; color: #374151; display: none; }
        .about-box.visible { display: block; }
        .about-box strong { color: #4f46e5; }

        .container { width: 100%; max-width: 900px; height: 560px; background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; overflow: hidden; }
        
        .visual-panel { width: 40%; background: #e0e7ff; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 20px; text-align: center; }
        .visual-panel h3 { margin: 0 0 12px; font-size: 1rem; color: #3730a3; }
        .scenario-selector { margin-bottom: 8px; padding: 10px; border-radius: 8px; border: 1px solid #a5b4fc; width: 100%; max-width: 200px; background: #fff; }
        .scenario-goal { font-size: 0.8rem; color: #6366f1; margin-bottom: 12px; min-height: 2.2em; font-style: italic; }
        .scenario-goal .badge { display: inline-block; background: #22c55e; color: white; padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; font-style: normal; margin-top: 4px; }
        .avatar-box { width: 160px; height: 160px; background: #c7d2fe; border-radius: 50%; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; font-size: 64px; border: 5px solid white; transition: all 0.3s ease; }
        .mood-text { color: #666; font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; }
        .session-stats { font-size: 0.75rem; color: #6b7280; margin-bottom: 8px; }
        .btn-end { padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        .btn-end:hover { background: #4f46e5; }
        
        .chat-panel { width: 60%; display: flex; flex-direction: column; }
        .chat-window { flex: 1; padding: 20px; overflow-y: auto; background: #fff; border-bottom: 1px solid #eee; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 15px; max-width: 70%; line-height: 1.4; font-size: 14px; }
        .message.user { background: #4f46e5; color: white; align-self: flex-end; margin-left: auto; }
        .message.ai { background: #f3f4f6; color: #333; align-self: flex-start; }
        .suggestions-row { padding: 10px 16px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; min-height: 48px; }
        .suggestions-row .label { font-size: 0.8rem; color: #64748b; margin-right: 8px; flex-shrink: 0; }
        .suggestion-chip { padding: 8px 14px; background: #e0e7ff; color: #4338ca; border: 1px solid #a5b4fc; border-radius: 20px; cursor: pointer; font-size: 0.85rem; }
        .suggestion-chip:hover { background: #c7d2fe; }
        .input-area { padding: 16px; background: #fff; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        button.send-btn { padding: 10px 24px; background: #4f46e5; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; }
        button.send-btn:hover { background: #4338ca; }
        button.try-again { padding: 8px 14px; background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; border-radius: 20px; cursor: pointer; font-size: 0.85rem; }
        button.try-again:hover { background: #fde68a; }

        .feedback-toast {
            position: fixed; top: 20px; right: 20px; background: #fee2e2; color: #b91c1c; 
            padding: 14px 18px; border-radius: 8px; border-left: 5px solid #ef4444; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; animation: slideIn 0.3s ease; z-index: 100; max-width: 320px;
        }
        .feedback-toast .try-hint { margin-top: 8px; font-size: 0.85rem; color: #991b1b; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .goal-toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #dcfce7; color: #166534;
            padding: 12px 20px; border-radius: 12px; border: 2px solid #22c55e; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none; animation: popIn 0.3s ease; z-index: 99; font-weight: 600;
        }
        @keyframes popIn { from { opacity: 0; transform: translateX(-50%) scale(0.9); } to { opacity: 1; transform: translateX(-50%) scale(1); } }

        .recap-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 200; }
        .recap-overlay.visible { display: flex; }
        .recap-box { background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .recap-box h2 { margin: 0 0 16px; color: #3730a3; font-size: 1.25rem; }
        .recap-box p { margin: 0 0 12px; color: #374151; font-size: 0.95rem; line-height: 1.5; }
        .recap-box .stat { background: #e0e7ff; padding: 8px 12px; border-radius: 8px; margin: 8px 0; }
        .recap-box button { margin-top: 16px; padding: 10px 24px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .recap-box button:hover { background: #4338ca; }

        /* Login overlay ‚Äì covers screen until user logs in */
        .login-overlay {
            position: fixed; inset: 0; background: linear-gradient(135deg, #3730a3 0%, #6366f1 100%);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .login-overlay.hidden { display: none; }
        .login-box {
            background: white; border-radius: 16px; padding: 32px; width: 100%; max-width: 360px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .login-box h2 { margin: 0 0 24px; color: #3730a3; font-size: 1.5rem; text-align: center; }
        .login-box label { display: block; margin-bottom: 4px; font-size: 0.9rem; color: #374151; }
        .login-box input[type="text"],
        .login-box input[type="password"] {
            width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid #ddd; border-radius: 8px;
            font-size: 1rem; box-sizing: border-box;
        }
        .login-box button { width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; }
        .login-box .btn-login { background: #4f46e5; color: white; }
        .login-box .btn-login:hover { background: #4338ca; }
        .login-box .btn-signup { background: #e0e7ff; color: #4f46e5; }
        .login-box .btn-signup:hover { background: #c7d2fe; }
        .login-box .welcome { margin-top: 16px; font-size: 0.9rem; color: #22c55e; text-align: center; display: none; }

        .coins-bar { position: fixed; top: 16px; right: 20px; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; z-index: 50; }
        .coins-bar .coin-count { background: #fef3c7; color: #92400e; padding: 6px 12px; border-radius: 20px; font-weight: 700; }
        .coins-bar .btn-shop { padding: 6px 14px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        .coins-bar .btn-shop:hover { background: #4338ca; }

        .shop-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 300; }
        .shop-overlay.visible { display: flex; }
        .shop-overlay.visible .shop-box { animation: shopBob 0.5s ease-out; }
        @keyframes shopBob {
            0% { transform: scale(0.9) translateY(-20px); opacity: 0; }
            50% { transform: scale(1.02) translateY(4px); }
            70% { transform: scale(0.98) translateY(-2px); }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .shop-box { position: relative; background: white; border-radius: 16px; padding: 24px; padding-top: 36px; max-width: 420px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .shop-box .shop-close-x { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; padding: 0; background: #dc2626; color: white; border: none; border-radius: 50%; font-size: 18px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .shop-box .shop-close-x:hover { background: #b91c1c; }
        .shop-box h2 { margin: 0 0 8px; color: #3730a3; font-size: 1.25rem; }
        .shop-box .shop-coins { font-size: 0.9rem; color: #6366f1; margin-bottom: 16px; }
        .shop-item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px 14px; margin-bottom: 10px; }
        .shop-item.owned { border-color: #22c55e; background: #dcfce7; }
        .shop-item h4 { margin: 0 0 4px; font-size: 1rem; color: #374151; }
        .shop-item p { margin: 0 0 8px; font-size: 0.85rem; color: #6b7280; }
        .shop-item .cost { font-weight: 700; color: #92400e; }
        .shop-item button { padding: 6px 12px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        .shop-item button:hover { background: #4338ca; }
        .shop-item button:disabled { background: #9ca3af; cursor: not-allowed; }
        .shop-item .owned-badge { color: #166534; font-size: 0.85rem; font-weight: 600; }
    </style>
</head>
<body>
<!-- Full-window background: same image as scenarioImg (updated in JS); scenarioImageContainer unchanged -->
<div class="scenario-bg" id="scenarioBg"></div>

<!-- Login overlay: shown on load, hidden after successful login -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <h2>SociAble</h2>
        <label for="loginUsername">Username</label>
        <input type="text" id="loginUsername" placeholder="Username" autocomplete="username">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
        <button type="button" class="btn-login" id="btnLogin">Login</button>
        <button type="button" class="btn-signup" id="btnSignup">Sign Up</button>
        <p class="welcome" id="loginWelcome">Welcome! Loading...</p>
    </div>
</div>

<div class="coins-bar" id="coinsBar" style="display: none;">
    <span class="coin-count">ü™ô <span id="coinCount">0</span> coins</span>
    <button type="button" class="btn-shop" id="btnShop">Reward Shop</button>
</div>

<div class="hero">
    <h1>SociAble</h1>
    <p>Practice social situations in a safe sandbox. Your words change how the character feels.</p>
    <button type="button" class="about-toggle" id="aboutToggle">What is SociAble?</button>
    <a href="dashboard.html" class="about-toggle" style="margin-left: 8px; text-decoration: none;">Analytics</a>
</div>
<div class="about-box" id="aboutBox">
    <strong>Not just a chatbot.</strong> SociAble is a social practice sandbox for kids: pick a scenario (grocery store, playground, classroom), talk to a character, and see how your words affect their mood. If you're kind, they smile. If you're rude, they get hurt‚Äîso you learn cause and effect in a safe space. The "vibe check" gently flags mean language and suggests rephrasing instead of blocking. <strong>Goal:</strong> practice real social moments with real emotional feedback.
    <p style="margin-top: 12px; margin-bottom: 0;"><strong>How can SociAble help an autistic child?</strong> Many autistic children find social situations unpredictable and overwhelming. SociAble is designed to support practice in ways that can reduce that stress: <strong>predictable scenarios</strong> (same places, clear goals) so there‚Äôs less surprise; <strong>visual feedback</strong> (the character‚Äôs face and mood) so the link between words and feelings is clear; <strong>no real-world consequences</strong>‚Äîmistakes only affect the character in the sandbox, so it‚Äôs safe to try and rephrase; <strong>gentle ‚Äútry again‚Äù</strong> instead of harsh correction when language is unkind; and <strong>clear goals per scenario</strong> so practice has structure. It‚Äôs a tool to rehearse social moments at the child‚Äôs pace, and works well alongside a parent, caregiver, or educator.</p>
</div>

<div class="container">
    <div class="visual-panel">
        <h3>Current Scenario</h3>
        <select id="scenarioSelect" class="scenario-selector">
            <option value="Grocery Store">Grocery Store</option>
            <option value="Playground">Playground</option>
            <option value="Classroom">Classroom</option>
        </select>
        <p class="scenario-goal" id="scenarioGoal">Goal: Make them smile with something kind.</p>
        
        <div class="avatar-box" id="avatarDisplay">üòê</div>
        <p id="moodText" class="mood-text">Neutral</p>
        <p class="session-stats" id="sessionStats">Kind moments: 0 ¬∑ Flagged: 0</p>
        <button type="button" class="btn-end" id="btnEndPractice">End practice</button>
    </div>

    <div class="chat-panel">
        <div class="chat-window" id="chatWindow">
            <div class="message ai">Hi! I'm ready to practice. Pick a scenario and say hello!</div>
        </div>
        <div class="suggestions-row" id="suggestionsRow">
            <span class="label">Suggest:</span>
            <button type="button" class="suggestion-chip" data-text="Hi!">Hi!</button>
            <button type="button" class="suggestion-chip" data-text="Hello!">Hello!</button>
            <button type="button" class="suggestion-chip" data-text="Can you help me?">Can you help me?</button>
            <button type="button" class="suggestion-chip" data-text="Thank you">Thank you</button>
        </div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Type your message here..." onkeypress="handleEnter(event)">
            <button type="button" class="try-again" id="btnTryAgain" style="display: none;">Try again</button>
            <button type="button" class="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<div id="feedbackToast" class="feedback-toast">
    <strong>‚ö†Ô∏è Vibe Check:</strong> <span id="feedbackText"></span>
    <div class="try-hint" id="tryHint">Try rephrasing in a kinder way, then click "Try again" to focus.</div>
</div>
<div id="goalToast" class="goal-toast">üéâ Goal reached! You made them smile.</div>

<div class="recap-overlay" id="recapOverlay">
    <div class="recap-box">
        <h2>Practice summary</h2>
        <p id="recapSummary">No messages yet. Send a few and come back!</p>
        <div class="stat" id="recapStats"></div>
        <p id="recapTip" style="font-size: 0.85rem; color: #6b7280;"></p>
        <button type="button" id="btnCloseRecap">Start new practice</button>
    </div>
</div>

<div class="shop-overlay" id="shopOverlay">
    <div class="shop-box">
        <button type="button" class="shop-close-x" id="shopCloseX" aria-label="Close shop">√ó</button>
        <h2>Reward Shop</h2>
        <p class="shop-coins">You have <strong id="shopCoinCount">0</strong> coins</p>
        <div id="shopRewardsList"></div>
    </div>
</div>

<script>
    const API_BASE = 'http://127.0.0.1:8000/api';
    let userToken = null; // Auth token; set after login

    const chatWindow = document.getElementById('chatWindow');
    const avatarDisplay = document.getElementById('avatarDisplay');
    const moodText = document.getElementById('moodText');
    const feedbackToast = document.getElementById('feedbackToast');
    const userInput = document.getElementById('userInput');
    const btnTryAgain = document.getElementById('btnTryAgain');
    const scenarioSelect = document.getElementById('scenarioSelect');
    const scenarioGoalEl = document.getElementById('scenarioGoal');
    const sessionStatsEl = document.getElementById('sessionStats');
    const recapOverlay = document.getElementById('recapOverlay');
    const recapSummary = document.getElementById('recapSummary');
    const recapStats = document.getElementById('recapStats');
    const recapTip = document.getElementById('recapTip');
    const goalToast = document.getElementById('goalToast');
    const loginOverlay = document.getElementById('loginOverlay');
    const loginWelcome = document.getElementById('loginWelcome');
    const suggestionsRow = document.getElementById('suggestionsRow');
    const coinsBar = document.getElementById('coinsBar');
    const coinCountEl = document.getElementById('coinCount');
    const shopOverlay = document.getElementById('shopOverlay');
    const shopCoinCount = document.getElementById('shopCoinCount');
    const shopRewardsList = document.getElementById('shopRewardsList');

    // Suggestion chips: click sends that text as the message (dialogue-based)
    suggestionsRow.addEventListener('click', function (e) {
        const chip = e.target.closest('.suggestion-chip');
        if (!chip) return;
        const text = chip.getAttribute('data-text');
        if (text) {
            userInput.value = text;
            sendMessage();
        }
    });

    function renderSuggestions(suggestions) {
        suggestionsRow.innerHTML = '';
        const label = document.createElement('span');
        label.className = 'label';
        label.textContent = 'Suggest:';
        suggestionsRow.appendChild(label);
        (suggestions || []).forEach(function (s) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'suggestion-chip';
            btn.setAttribute('data-text', s);
            btn.textContent = s;
            suggestionsRow.appendChild(btn);
        });
    }

    // Restore token from localStorage (e.g. after refresh or when opening dashboard)
    if (localStorage.getItem('sociable_token')) {
        userToken = localStorage.getItem('sociable_token');
        loginOverlay.classList.add('hidden');
        fetchProfile();
    }

    // Session stats (makes it a practice tool, not just chat)
    let kindMoments = 0, flaggedCount = 0, hurtMoments = 0, totalMessages = 0;
    const scenariosUsed = new Set();
    const goalsReached = new Set(); // per scenario

    const SCENARIO_GOALS = {
        'Grocery Store': 'Goal: Make them smile (e.g. say please, thank you).',
        'Playground': 'Goal: Be friendly and include others.',
        'Classroom': 'Goal: Ask for help politely or say sorry if needed.'
    };

    const SCENARIO_IMAGES = {
    'Grocery Store': 'static/grocery_shop.png',
    'Playground': 'static/playground.png',
    'Classroom': 'static/classroom.png'
    };

    document.getElementById('aboutToggle').onclick = function () {
        document.getElementById('aboutBox').classList.toggle('visible');
    };
    document.getElementById('btnEndPractice').onclick = function () { showRecap(); };
    document.getElementById('btnCloseRecap').onclick = function () {
        recapOverlay.classList.remove('visible');
        resetChat();
    };
    document.getElementById('btnShop').onclick = openShop;
    document.getElementById('shopCloseX').onclick = function () { shopOverlay.classList.remove('visible'); };
    scenarioSelect.addEventListener('change', function () {
        resetChat();
        updateScenarioGoal();
    });
    btnTryAgain.onclick = function () { userInput.focus(); };
    document.getElementById('btnLogin').onclick = handleLogin;
    document.getElementById('btnSignup').onclick = handleSignup;

    async function fetchProfile() {
        if (!userToken) return;
        try {
            const r = await fetch(API_BASE + '/profile/', { headers: { 'Authorization': 'Token ' + userToken } });
            if (r.ok) {
                const d = await r.json();
                coinCountEl.textContent = d.coins;
                shopCoinCount.textContent = d.coins;
                coinsBar.style.display = 'flex';
            }
        } catch (e) { console.warn('Profile fetch failed', e); }
    }

    async function awardCoins(amount) {
        if (!userToken || !amount) return;
        try {
            const r = await fetch(API_BASE + '/coins/award/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Token ' + userToken },
                body: JSON.stringify({ amount: amount })
            });
            if (r.ok) {
                const d = await r.json();
                coinCountEl.textContent = d.coins;
                shopCoinCount.textContent = d.coins;
            }
        } catch (e) { console.warn('Award coins failed', e); }
    }

    async function openShop() {
        shopOverlay.classList.add('visible');
        if (!userToken) return;
        try {
            const r = await fetch(API_BASE + '/shop/', { headers: { 'Authorization': 'Token ' + userToken } });
            if (!r.ok) return;
            const d = await r.json();
            shopCoinCount.textContent = d.coins;
            shopRewardsList.innerHTML = '';
            (d.rewards || []).forEach(function (reward) {
                const div = document.createElement('div');
                div.className = 'shop-item' + (reward.owned ? ' owned' : '');
                div.innerHTML = '<h4>' + reward.name + '</h4><p>' + reward.description + '</p>' +
                    (reward.owned ? '<span class="owned-badge">‚úì Owned</span>' :
                        '<span class="cost">' + reward.cost + ' coins</span> &nbsp; <button type="button" data-reward-id="' + reward.id + '" data-cost="' + reward.cost + '">Redeem</button>');
                shopRewardsList.appendChild(div);
            });
            shopRewardsList.querySelectorAll('button[data-reward-id]').forEach(function (btn) {
                btn.onclick = function () { redeemReward(btn.getAttribute('data-reward-id'), parseInt(btn.getAttribute('data-cost'), 10)); };
            });
        } catch (e) { console.warn('Shop fetch failed', e); }
    }

    async function redeemReward(rewardId, cost) {
        if (!userToken || !rewardId) return;
        try {
            const r = await fetch(API_BASE + '/shop/redeem/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Token ' + userToken },
                body: JSON.stringify({ reward_id: rewardId })
            });
            const d = await r.json().catch(function () { return {}; });
            if (r.ok) {
                coinCountEl.textContent = d.coins;
                shopCoinCount.textContent = d.coins;
                openShop(); // refresh list to show owned
            } else {
                alert(d.error || 'Could not redeem.');
            }
        } catch (e) { alert('Error: ' + e.message); }
    }

    async function handleSignup() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!username || !password) {
            alert('Please enter a username and password.');
            return;
        }
        try {
            const response = await fetch(API_BASE + '/signup/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: password })
            });
            const data = response.ok ? await response.json().catch(() => ({})) : null;
            if (response.ok) {
                alert('Sign up successful! You can now log in.');
            } else {
                const err = data && (data.username || data.password || data.non_field_errors);
                alert('Sign up failed: ' + (err ? (Array.isArray(err) ? err.join(' ') : err) : response.statusText));
            }
        } catch (e) {
            alert('Sign up failed: ' + e.message);
        }
    }

    async function handleLogin() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!username || !password) {
            alert('Please enter username and password.');
            return;
        }
        loginWelcome.style.display = 'block';
        loginWelcome.textContent = 'Logging in...';
        try {
            const response = await fetch(API_BASE + '/login/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: password })
            });
            const data = await response.json().catch(() => ({}));
            if (response.ok && data.token) {
                userToken = data.token;
                localStorage.setItem('sociable_token', userToken);
                loginWelcome.textContent = 'Welcome, ' + username + '!';
                fetchProfile();
                setTimeout(function () {
                    loginOverlay.classList.add('hidden');
                }, 800);
            } else {
                loginWelcome.style.display = 'none';
                alert('Login failed: ' + (data.non_field_errors ? data.non_field_errors.join(' ') : 'Invalid credentials.'));
            }
        } catch (e) {
            loginWelcome.style.display = 'none';
            alert('Login failed: ' + e.message);
        }
    }

    const DEFAULT_GREETING = "Hi! I'm ready to practice. Pick a scenario and say hello!";

    function resetChat() {
        chatWindow.innerHTML = '';
        const div = document.createElement('div');
        div.className = 'message ai';
        div.textContent = DEFAULT_GREETING;
        chatWindow.appendChild(div);
        kindMoments = 0;
        flaggedCount = 0;
        hurtMoments = 0;
        totalMessages = 0;
        scenariosUsed.clear();
        updateSessionStats();
        updateAvatar('NEUTRAL');
        renderSuggestions(['Hi!', 'Hello!', 'Can you help me?', 'Thank you']);
    }

    function updateScenarioGoal() {
        const scenario = scenarioSelect.value;
        scenarioGoalEl.innerHTML = SCENARIO_GOALS[scenario] || 'Goal: Make them smile with something kind.';
        if (goalsReached.has(scenario)) {
            scenarioGoalEl.innerHTML += ' <span class="badge">Done</span>';
        }

        const scenarioImgUrl = SCENARIO_IMAGES[scenario];
        const scenarioBg = document.getElementById('scenarioBg');
        if (scenarioBg && scenarioImgUrl) {
            scenarioBg.style.backgroundImage = 'url(' + scenarioImgUrl + ')';
        }
    }
    function updateSessionStats() {
        sessionStatsEl.textContent = `Kind moments: ${kindMoments} ¬∑ Flagged: ${flaggedCount}${hurtMoments ? ` ¬∑ Hurt: ${hurtMoments}` : ''}`;
    }
    function showRecap() {
        const total = totalMessages;
        let summary;
        if (total === 0) {
            summary = 'No messages yet. Send a few and come back!';
        } else {
            summary = 'Overall: ' + total + ' message' + (total !== 1 ? 's' : '') + ' in this practice. ';
            summary += kindMoments + ' kind moment' + (kindMoments !== 1 ? 's' : '') + '. ';
            if (flaggedCount) summary += flaggedCount + ' rephrased (vibe check). ';
            if (hurtMoments) summary += 'The character felt hurt ' + hurtMoments + ' time(s). ';
            if (kindMoments > 0 && hurtMoments === 0) summary += 'Great job!';
            else if (kindMoments > 0) summary += 'Keep it up!';
            else summary += 'Try saying something kind next time.';
        }
        recapSummary.textContent = summary;
        recapStats.textContent = 'Scenario: ' + scenarioSelect.value + ' ¬∑ Kind: ' + kindMoments + ' ¬∑ Flagged: ' + flaggedCount + (hurtMoments ? ' ¬∑ Hurt: ' + hurtMoments : '');
        recapTip.textContent = kindMoments > 0 ? 'This conversation has been saved. Parents can review it in Analytics.' : 'Try saying something kind to see them smile.';
        recapOverlay.classList.add('visible');

        // Log conversation for parent review
        const messages = [];
        chatWindow.querySelectorAll('.message').forEach(function (el) {
            const sender = el.classList.contains('user') ? 'user' : 'assistant';
            const text = el.textContent.trim();
            const mood = el.getAttribute('data-mood') || '';
            messages.push({ sender: sender, text: text, mood: mood });
        });
        if (userToken && messages.length > 0) {
            fetch(API_BASE + '/practice/end/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Token ' + userToken },
                body: JSON.stringify({
                    scenario: scenarioSelect.value,
                    messages: messages,
                    total_messages: totalMessages,
                    kind_moments: kindMoments,
                    flagged_count: flaggedCount,
                    hurt_moments: hurtMoments
                })
            }).catch(function () {});
        }
    }
    function showGoalReached() {
        goalToast.style.display = 'block';
        setTimeout(() => { goalToast.style.display = 'none'; }, 2500);
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        const scenario = scenarioSelect.value;

        if (!text) return;

        addMessage(text, 'user');
        userInput.value = '';
        btnTryAgain.style.display = 'none';
        totalMessages++;
        scenariosUsed.add(scenario);

        // Build conversation history (all messages except the one we just added) for context
        const history = [];
        const messages = chatWindow.querySelectorAll('.message');
        for (let i = 0; i < messages.length - 1; i++) {
            const el = messages[i];
            const sender = el.classList.contains('user') ? 'user' : 'assistant';
            history.push({ sender: sender, text: el.textContent.trim() });
        }

        try {
            const headers = { 'Content-Type': 'application/json' };
            if (userToken) headers['Authorization'] = 'Token ' + userToken;
            const response = await fetch(API_BASE + '/chat/', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ message: text, scenario: scenario, history: history })
            });

            if (response.status === 401) {
                userToken = null;
                localStorage.removeItem('sociable_token');
                loginOverlay.classList.remove('hidden');
                addMessage('Please log in again.', 'ai', 'NEUTRAL');
                return;
            }
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server error: ${response.status} - ${errorText.substring(0, 100)}`);
            }
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const t = await response.text();
                throw new Error(`Expected JSON but got ${contentType}. Response: ${t.substring(0, 100)}`);
            }

            const data = await response.json();

            if (data.status === 'error') {
                addMessage(data.reply, 'ai', data.mood || 'NEUTRAL');
                updateAvatar(data.mood || 'NEUTRAL');
                renderSuggestions(data.suggestions || []);
            } else if (data.status === 'flagged') {
                flaggedCount++;
                updateSessionStats();
                showFeedback(data.feedback);
                chatWindow.lastElementChild.remove();
                btnTryAgain.style.display = 'inline-block';
                userInput.placeholder = 'Try a kinder way to say it...';
                setTimeout(() => { userInput.placeholder = 'Type your message here...'; }, 3000);
                renderSuggestions(data.suggestions || ['Hi!', 'Thank you', 'Can you help me?', 'Sorry']);
            } else {
                addMessage(data.reply, 'ai', data.mood);
                updateAvatar(data.mood);
                renderSuggestions(data.suggestions || []);
                if (data.mood === 'HAPPY') {
                    kindMoments++;
                    awardCoins(5); // 5 coins per kind moment
                    if (!goalsReached.has(scenario)) {
                        goalsReached.add(scenario);
                        scenarioGoalEl.innerHTML = (SCENARIO_GOALS[scenario] || 'Goal: Make them smile.') + ' <span class="badge">Done</span>';
                        showGoalReached();
                        awardCoins(15); // 15 coins bonus for reaching goal (making them smile)
                    }
                } else if (data.mood === 'SAD' || data.mood === 'ANGRY') {
                    hurtMoments++;
                }
                updateSessionStats();
            }
        } catch (error) {
            console.error('Error:', error);
            addMessage('‚ö†Ô∏è System Offline. Check backend terminal.', 'ai', 'NEUTRAL');
        }
    }

    function addMessage(text, sender, mood) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.textContent = text;
        if (sender === 'ai' && mood) div.setAttribute('data-mood', mood);
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function updateAvatar(mood) {
        let emoji = 'üòê', color = '#c7d2fe';
        if (mood === 'HAPPY') { emoji = 'üòÑ'; color = '#bbf7d0'; }
        if (mood === 'SAD') { emoji = 'üò¢'; color = '#fecaca'; }
        if (mood === 'ANGRY') { emoji = 'üò°'; color = '#fecaca'; }
        avatarDisplay.textContent = emoji;
        avatarDisplay.style.backgroundColor = color;
        moodText.textContent = mood ? mood.charAt(0).toUpperCase() + mood.slice(1).toLowerCase() : 'Neutral';
    }

    function showFeedback(text) {
        document.getElementById('feedbackText').textContent = text;
        feedbackToast.style.display = 'block';
        setTimeout(() => { feedbackToast.style.display = 'none'; }, 5000);
    }

    updateScenarioGoal();
</script>

</body>
</html>